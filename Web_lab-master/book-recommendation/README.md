# 模型训练和评估

本代码使用TensorFlow实现了一个基于神经网络的推荐系统模型。该模型接收书籍标题、地理位置和用户年龄作为输入，并预测用户对书籍的评分。

## 数据集拆分

使用`split_data`函数将原始数据集拆分为训练集、验证集和测试集。通过指定`train_test_val_split`参数来控制拆分比例。例如，`train_test_val_split = [0.7, 0.9, 1]`表示训练集占总数据集的70%，验证集占总数据集的20%，测试集占总数据集的10%。

## 构建TF Dataset

使用`build_tf_dataset`函数将拆分后的数据集构建为TensorFlow的`tf.Dataset`对象。首先将数据集转换为张量切片，并应用预处理函数`preprocess`对数据进行处理。然后使用`batch`方法将数据集分批。

## 模型定义

定义了一个名为`RecomModel`的子类，继承自`tf.keras.Model`。模型包含了嵌入层、隐藏层和输出层。地理位置使用嵌入层进行编码，然后将标题、地理位置和年龄特征进行合并，然后通过批归一化和Dropout进行处理。最后通过隐藏层和输出层进行预测。

## 损失函数和优化器

使用`CategoricalCrossentropy`作为损失函数，并使用Adam优化器进行参数优化。

## 训练循环

定义了训练和验证的循环。在训练循环中，使用`train_step`函数计算模型的输出和损失，并使用优化器更新模型参数。在验证循环中，使用`val_step`函数计算模型在验证集上的损失。

## 提前停止

使用自定义的`CustomEarlyStopping`类实现了提前停止功能。当验证损失连续多次不降低时，训练过程将提前结束。

## 模型训练和评估

通过迭代训练和验证循环，对模型进行训练，并在每个epoch结束时打印训练损失和验证损失。同时，使用`early_stopping`对象进行提前停止判断，当满足停止条件时，训练过程将结束。
